<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reconhecimento dos Guardas - Forjador de Lendas</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Reset CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <!-- CSS do projeto -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/login-page.css">
    <link rel="stylesheet" href="css/login-guards.css">
    
</head>
<body class="no-js">
    <script>document.body.classList.remove('no-js');</script>

    <!-- Overlay de névoa mais sutil para login -->
    <div class="fog-overlay" style="opacity: 0.05;"></div>

    <!-- Guardas laterais -->
    <div class="left-guard">
        <div class="guard-speech-bubble hidden">
            <p id="leftGuardText">Alto, viajante! Identificação necessária para prosseguir.</p>
        </div>
        <img src="assets/img/guarda-1.png" alt="Guarda Esquerdo" class="guard-image" id="leftGuardAvatar">
    </div>
    <div class="right-guard">
        <div class="guard-speech-bubble hidden">
            <p id="rightGuardText">Os portões do Reino aguardam sua passagem autorizada.</p>
        </div>
        <img src="assets/img/guarda-2.png" alt="Guarda Direito" class="guard-image" id="rightGuardAvatar">
    </div>

    <div class="login-container">
        <div class="guard-castle">
            <!-- Login Card -->
            <div id="loginCard" class="auth-card">
            <div class="castle-header">
                <h1 class="castle-title">
                    <i class="fas fa-shield-alt"></i>
                    Reconhecimento
                </h1>
            </div>

            <div class="guard-message">
                <p>
                    <strong>Alto lá, viajante!</strong><br>
                    Nossos guardas precisam verificar sua identidade antes de permitir 
                    o acesso aos segredos do Forjador de Lendas. Identifique-se!
                </p>
            </div>

            <form id="recognitionForm" class="recognition-form">
                <div class="field-group">
                    <label class="field-label" for="username">
                        <i class="fas fa-user"></i>
                        Nome do Aventureiro
                    </label>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="username" 
                            name="email"
                            class="field-input"
                            placeholder="Digite seu email ou nome de aventureiro"
                            required
                            autocomplete="username email"
                        >
                        <i class="fas fa-user field-icon"></i>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="password">
                        <i class="fas fa-key"></i>
                        Palavra de Reconhecimento
                    </label>
                    <div class="input-container">
                        <input 
                            type="password" 
                            id="password" 
                            name="password"
                            class="field-input"
                            placeholder="Digite sua palavra secreta"
                            required
                            autocomplete="current-password"
                        >
                        <i class="fas fa-lock field-icon"></i>
                    </div>
                </div>

                <div class="remember-guards">
                    <div class="custom-checkbox">
                        <input type="checkbox" id="rememberMe">
                        <span class="checkmark"></span>
                    </div>
                    <label for="rememberMe" class="remember-text">
                        Lembrar desta jornada pelos próximos 30 dias
                    </label>
                </div>

                <button type="submit" class="guard-button" id="submitButton">
                    <i class="fas fa-dungeon"></i>
                    Passar pelos Guardas
                </button>

                <div id="statusMessage" class="status-message"></div>
            </form>

            <div class="castle-footer">
                <p class="footer-text">
                    Primeiro acesso? <a href="#" class="footer-link" id="registerLink">Solicite passagem aos guardas</a>
                </p>
                <p class="footer-text" style="margin-top: 0.3rem;">
                    <a href="#" class="footer-link" id="forgotPasswordLink">Esqueceu sua palavra de reconhecimento?</a>
                </p>
                </div>
            </div>

            <!-- Forgot Password Card -->
            <div id="forgotPasswordCard" class="auth-card hidden">
                <div class="castle-header">
                    <h1 class="castle-title">
                        <i class="fas fa-key"></i>
                        Recuperar Palavra
                    </h1>
                </div>

                <div class="guard-message">
                    <p>
                        <strong>Esqueceu sua palavra de reconhecimento?</strong><br>
                        Nossos guardas podem enviar uma nova palavra secreta para seu correio. 
                        Informe o endereço registrado nos pergaminhos do reino.
                    </p>
                </div>

                <form id="forgotPasswordForm" class="recognition-form">
                    <div class="field-group">
                        <label class="field-label" for="forgotEmail">
                            <i class="fas fa-envelope"></i>
                            Correio do Reino
                        </label>
                        <div class="input-container">
                            <input 
                                type="email" 
                                id="forgotEmail" 
                                class="field-input"
                                placeholder="seu.email@reino.com"
                                required
                                autocomplete="email"
                            >
                            <i class="fas fa-envelope field-icon"></i>
                        </div>
                    </div>

                    <button type="submit" class="guard-button" id="forgotPasswordButton">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Nova Palavra
                    </button>

                    <div id="forgotPasswordStatusMessage" class="status-message"></div>
                </form>

                <div class="castle-footer">
                    <p class="footer-text">
                        Lembrou da palavra? <a href="#" class="footer-link" id="backToLoginLink">Retornar ao reconhecimento</a>
                    </p>
                </div>
            </div>

            <!-- Register Card -->
            <div id="registerCard" class="auth-card hidden">
                <div class="castle-header">
                    <h1 class="castle-title">
                        <i class="fas fa-scroll"></i>
                        Registro de Aventureiro
                    </h1>
                </div>

                <div class="guard-message">
                    <p>
                        <strong>Bem-vindo, futuro aventureiro!</strong><br>
                        Para se tornar um membro do reino, nossos guardas precisam 
                        registrar suas informações nos pergaminhos oficiais.
                    </p>
                </div>

                <form id="registrationForm" class="recognition-form">
                    <div class="field-group">
                        <label class="field-label" for="regUsername">
                            <i class="fas fa-user"></i>
                            Nome do Aventureiro
                        </label>
                        <div class="input-container">
                            <input 
                                type="text" 
                                id="regUsername" 
                                name="username"
                                class="field-input"
                                placeholder="Escolha seu nome de aventureiro"
                                required
                                autocomplete="username"
                            >
                            <i class="fas fa-user field-icon"></i>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label" for="regEmail">
                            <i class="fas fa-envelope"></i>
                            Correio do Reino
                        </label>
                        <div class="input-container">
                            <input 
                                type="email" 
                                id="regEmail" 
                                name="email"
                                class="field-input"
                                placeholder="seu.email@reino.com"
                                required
                                autocomplete="email"
                            >
                            <i class="fas fa-envelope field-icon"></i>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label" for="regPassword">
                            <i class="fas fa-key"></i>
                            Palavra de Reconhecimento
                        </label>
                        <div class="input-container">
                            <input 
                                type="password" 
                                id="regPassword" 
                                name="password"
                                class="field-input"
                                placeholder="Crie uma palavra secreta forte"
                                required
                                autocomplete="new-password"
                            >
                            <i class="fas fa-lock field-icon"></i>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label" for="regConfirmPassword">
                            <i class="fas fa-key"></i>
                            Confirmar Palavra
                        </label>
                        <div class="input-container">
                            <input 
                                type="password" 
                                id="regConfirmPassword" 
                                name="confirmPassword"
                                class="field-input"
                                placeholder="Digite novamente sua palavra secreta"
                                required
                                autocomplete="new-password"
                            >
                            <i class="fas fa-lock field-icon"></i>
                        </div>
                    </div>

                    <div class="remember-guards">
                        <div class="custom-checkbox">
                            <input type="checkbox" id="acceptTerms" required>
                            <span class="checkmark"></span>
                        </div>
                        <label for="acceptTerms" class="remember-text">
                            Aceito os termos do reino e o código de honra dos aventureiros
                        </label>
                    </div>

                    <button type="submit" class="guard-button" id="registerButton">
                        <i class="fas fa-scroll"></i>
                        Registrar no Reino
                    </button>

                    <div id="registerStatusMessage" class="status-message"></div>
                </form>

                <div class="castle-footer">
                    <p class="footer-text">
                        Já possui registro? <a href="#" class="footer-link" id="loginLink">Retornar ao reconhecimento</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="src/core/supabase.js"></script>
    <!-- Fix integrado para 100% Supabase Auth -->
    <script>
        // Limpeza de sistemas de auth legados
        document.addEventListener('DOMContentLoaded', () => {
            // Limpar localStorage de sistemas legados
            const legacyKeys = ['forjador_auth_token', 'forjador_user_data', 'forjador_remember_me'];
            legacyKeys.forEach(key => {
                if (localStorage.getItem(key)) {
                    localStorage.removeItem(key);
                }
            });
            
            // Marcar modo Supabase-only
            window.SUPABASE_ONLY_MODE = true;
        });
    </script>
    
    <script type="module" src="js/login-manager.js"></script> <!-- Ativado - Sistema Supabase -->
    <!-- Script antigo comentado - agora usando Supabase -->
    <!--<script type="module">
        // Sistema de autenticação para página de login e registro
        class LoginPageAuth {
            constructor() {
                // Elementos do login
                this.loginCard = document.getElementById('loginCard');
                this.registerCard = document.getElementById('registerCard');
                this.forgotPasswordCard = document.getElementById('forgotPasswordCard');
                this.form = document.getElementById('recognitionForm');
                this.usernameInput = document.getElementById('username');
                this.passwordInput = document.getElementById('password');
                this.rememberInput = document.getElementById('rememberMe');
                this.submitButton = document.getElementById('submitButton');
                this.statusMessage = document.getElementById('statusMessage');
                
                // Elementos do registro
                this.registerForm = document.getElementById('registrationForm');
                this.regUsernameInput = document.getElementById('regUsername');
                this.regEmailInput = document.getElementById('regEmail');
                this.regPasswordInput = document.getElementById('regPassword');
                this.regConfirmPasswordInput = document.getElementById('regConfirmPassword');
                this.acceptTermsInput = document.getElementById('acceptTerms');
                this.registerButton = document.getElementById('registerButton');
                this.registerStatusMessage = document.getElementById('registerStatusMessage');
                
                // Elementos do esqueceu senha
                this.forgotPasswordForm = document.getElementById('forgotPasswordForm');
                this.forgotEmailInput = document.getElementById('forgotEmail');
                this.forgotPasswordButton = document.getElementById('forgotPasswordButton');
                this.forgotPasswordStatusMessage = document.getElementById('forgotPasswordStatusMessage');
                
                // Estado atual
                this.currentMode = 'login'; // 'login', 'register' ou 'forgot'
                
                this.init();
            }

            init() {
                // Verificar se já está logado
                this.checkExistingAuth();
                
                // Configurar event listeners para login
                this.form.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Configurar event listeners para registro
                this.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                
                // Configurar event listeners para esqueceu senha
                this.forgotPasswordForm.addEventListener('submit', (e) => this.handleForgotPassword(e));
                
                // Links de alternância entre login, registro e esqueceu senha
                document.getElementById('registerLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToRegister();
                });
                
                document.getElementById('loginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToLogin();
                });
                
                document.getElementById('backToLoginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToLogin();
                });
                
                document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToForgotPassword();
                });

                // Auto-focus no campo de usuário
                this.usernameInput.focus();
            }

            checkExistingAuth() {
                const token = localStorage.getItem('forjador_auth_token');
                const userData = localStorage.getItem('forjador_user_data');
                
                if (token && userData) {
                    try {
                        const user = JSON.parse(userData);
                        this.showMessage(`Bem-vindo de volta, ${user.username}! Redirecionando...`, 'success');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    } catch (error) {
                        console.error('Erro ao recuperar dados de auth:', error);
                        localStorage.removeItem('forjador_auth_token');
                        localStorage.removeItem('forjador_user_data');
                    }
                }
            }

            async handleLogin(event) {
                event.preventDefault();
                
                const username = this.usernameInput.value.trim();
                const password = this.passwordInput.value;
                const remember = this.rememberInput.checked;

                if (!username || !password) {
                    this.showMessage('Por favor, preencha todos os campos!', 'error');
                    return;
                }

                this.setLoading(true);
                this.showMessage('Os guardas estão verificando sua identidade...', 'loading');
                
                try {
                    const result = await this.authenticate(username, password);
                    
                    if (result.success) {
                        this.setAuthData(result.token, result.user, remember);
                        this.showMessage(`Acesso liberado! Bem-vindo, ${result.user.username}!`, 'success');
                        
                        // Definir mundo padrão se não existir
                        if (!localStorage.getItem('selectedWorld')) {
                            localStorage.setItem('selectedWorld', 'tormenta'); // Tormenta como padrão
                        }
                        
                        // Chamar reação dos guardas ao sucesso
                        if (window.loginGuards) {
                            window.loginGuards.onLoginSuccess();
                        }
                        
                        setTimeout(() => {
                            // Verificar se há URL para redirecionar após login
                            const redirectUrl = sessionStorage.getItem('forjador_redirect_after_login');
                            if (redirectUrl) {
                                sessionStorage.removeItem('forjador_redirect_after_login');
                                window.location.href = redirectUrl;
                            } else {
                            window.location.href = 'index.html';
                            }
                        }, 2000);
                    } else {
                        this.showMessage(result.message || 'Credenciais inválidas! Os guardas não reconhecem esta identidade.', 'error');
                        
                        // Chamar reação dos guardas ao erro
                        if (window.loginGuards) {
                            window.loginGuards.onLoginError();
                        }
                    }
                } catch (error) {
                    console.error('Erro no login:', error);
                    this.showMessage('Erro de conexão com os guardas. Tente novamente.', 'error');
                } finally {
                    this.setLoading(false);
                }
            }

            async authenticate(username, password) {
                // Simulação - substituir por chamada real da API
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const validUsers = {
                            'admin': 'admin123',
                            'forjador': 'lendas123',
                            'mestre': 'rpg2024'
                        };

                        if (validUsers[username] === password) {
                            resolve({
                                success: true,
                                token: 'guard_token_' + Date.now(),
                                user: {
                                    id: Math.floor(Math.random() * 1000),
                                    username: username,
                                    email: `${username}@forjador.com`,
                                    role: username === 'admin' ? 'admin' : 'user',
                                    createdAt: new Date().toISOString()
                                }
                            });
                        } else {
                            resolve({
                                success: false,
                                message: 'Nome ou palavra de reconhecimento incorretos!'
                            });
                        }
                    }, 1500); // Simula delay de rede
                });
            }

            setAuthData(token, user, remember) {
                localStorage.setItem('forjador_auth_token', token);
                localStorage.setItem('forjador_user_data', JSON.stringify(user));
                
                if (remember) {
                    localStorage.setItem('forjador_remember_me', 'true');
                }
            }

            setLoading(isLoading) {
                this.submitButton.disabled = isLoading;
                
                if (isLoading) {
                    this.submitButton.innerHTML = `
                        <span class="loading-spinner"></span>
                        Verificando...
                    `;
                } else {
                    this.submitButton.innerHTML = `
                        <i class="fas fa-dungeon"></i>
                        Passar pelos Guardas
                    `;
                }
            }

            showMessage(message, type, target = 'login') {
                let messageElement;
                
                if (target === 'login') {
                    messageElement = this.statusMessage;
                } else if (target === 'register') {
                    messageElement = this.registerStatusMessage;
                } else if (target === 'forgot') {
                    messageElement = this.forgotPasswordStatusMessage;
                }
                
                if (!messageElement) return;
                
                messageElement.textContent = message;
                messageElement.className = `status-message ${type}`;
                messageElement.style.display = 'block';
                
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        if (type === 'error') {
                            messageElement.style.display = 'none';
                        }
                    }, 5000);
                }
            }

            switchToRegister() {
                this.currentMode = 'register';
                this.hideAllCards();
                this.registerCard.classList.remove('hidden');
                
                // Adiciona classe para ajustar layout mobile
                const container = document.querySelector('.login-container');
                if (container && window.innerWidth < 1023) {
                    container.classList.add('register-mode');
                    
                    // Garante que começa do topo no mobile
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                // Informar guardas sobre mudança para registro
                if (window.loginGuards) {
                    window.loginGuards.onSwitchToRegister();
                }
                
                // Auto-focus no campo de usuário do registro (delay maior para aguardar scroll)
                setTimeout(() => {
                    this.regUsernameInput.focus();
                }, 500);
            }

            switchToLogin() {
                this.currentMode = 'login';
                this.hideAllCards();
                this.loginCard.classList.remove('hidden');
                
                // Remove classe do modo registro
                const container = document.querySelector('.login-container');
                if (container) {
                    container.classList.remove('register-mode');
                }
                
                // No mobile, retorna scroll para o topo suavemente
                if (window.innerWidth < 1023) {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                // Informar guardas sobre mudança para login
                if (window.loginGuards) {
                    window.loginGuards.onSwitchToLogin();
                }
                
                // Auto-focus no campo de usuário do login (delay maior para aguardar scroll)
                setTimeout(() => {
                    this.usernameInput.focus();
                }, 500);
            }

            switchToForgotPassword() {
                this.currentMode = 'forgot';
                this.hideAllCards();
                this.forgotPasswordCard.classList.remove('hidden');
                
                // Remove classe do modo registro se existir
                const container = document.querySelector('.login-container');
                if (container) {
                    container.classList.remove('register-mode');
                }
                
                // No mobile, vai para o topo
                if (window.innerWidth < 1023) {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                // Informar guardas sobre mudança para esqueceu senha
                if (window.loginGuards) {
                    window.loginGuards.onSwitchToForgotPassword();
                }
                
                // Auto-focus no campo de email
                setTimeout(() => {
                    this.forgotEmailInput.focus();
                }, 500);
            }

            hideAllCards() {
                this.loginCard.classList.add('hidden');
                this.registerCard.classList.add('hidden');
                this.forgotPasswordCard.classList.add('hidden');
            }

            async handleRegister(event) {
                event.preventDefault();
                
                const username = this.regUsernameInput.value.trim();
                const email = this.regEmailInput.value.trim();
                const password = this.regPasswordInput.value;
                const confirmPassword = this.regConfirmPasswordInput.value;
                const acceptTerms = this.acceptTermsInput.checked;

                // Validações
                if (!username || !email || !password || !confirmPassword) {
                    this.showMessage('Por favor, preencha todos os campos!', 'error', 'register');
                    return;
                }

                if (password !== confirmPassword) {
                    this.showMessage('As palavras de reconhecimento não coincidem!', 'error', 'register');
                    return;
                }

                if (password.length < 6) {
                    this.showMessage('A palavra de reconhecimento deve ter pelo menos 6 caracteres!', 'error', 'register');
                    return;
                }

                if (!acceptTerms) {
                    this.showMessage('Você deve aceitar os termos do reino para prosseguir!', 'error', 'register');
                    return;
                }

                this.setRegisterLoading(true);
                this.showMessage('Os guardas estão processando seu registro...', 'loading', 'register');
                
                try {
                    const result = await this.registerUser(username, email, password);
                    
                    if (result.success) {
                        this.showMessage(`Registro aprovado! Bem-vindo ao reino, ${username}!`, 'success', 'register');
                        
                        // Chamar reação dos guardas ao sucesso
                        if (window.loginGuards) {
                            window.loginGuards.onRegisterSuccess(username);
                        }
                        
                        // Após 2 segundos, trocar para login
                        setTimeout(() => {
                            this.switchToLogin();
                            this.usernameInput.value = username;
                            this.showMessage('Agora faça login com suas credenciais!', 'success');
                        }, 2500);
                    } else {
                        this.showMessage(result.message || 'Erro ao processar registro. Tente novamente.', 'error', 'register');
                        
                        // Chamar reação dos guardas ao erro
                        if (window.loginGuards) {
                            window.loginGuards.onRegisterError();
                        }
                    }
                } catch (error) {
                    console.error('Erro no registro:', error);
                    this.showMessage('Erro de conexão com os guardas. Tente novamente.', 'error', 'register');
                } finally {
                    this.setRegisterLoading(false);
                }
            }

            async registerUser(username, email, password) {
                // Simulação - substituir por chamada real da API
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Simular verificação de usuário existente
                        const existingUsers = ['admin', 'forjador', 'mestre'];
                        
                        if (existingUsers.includes(username.toLowerCase())) {
                            resolve({
                                success: false,
                                message: 'Este nome de aventureiro já está registrado no reino!'
                            });
                        } else if (username.length < 3) {
                            resolve({
                                success: false,
                                message: 'O nome do aventureiro deve ter pelo menos 3 caracteres!'
                            });
                        } else {
                            resolve({
                                success: true,
                                message: 'Registro realizado com sucesso!'
                            });
                        }
                    }, 2000); // Simula delay de rede
                });
            }

            setRegisterLoading(isLoading) {
                this.registerButton.disabled = isLoading;
                
                if (isLoading) {
                    this.registerButton.innerHTML = `
                        <span class="loading-spinner"></span>
                        Processando...
                    `;
                } else {
                    this.registerButton.innerHTML = `
                        <i class="fas fa-scroll"></i>
                        Registrar no Reino
                    `;
                }
            }

            async handleForgotPassword(event) {
                event.preventDefault();
                
                const email = this.forgotEmailInput.value.trim();

                if (!email) {
                    this.showMessage('Por favor, informe seu email!', 'error', 'forgot');
                    return;
                }

                // Validação básica de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.showMessage('Por favor, informe um email válido!', 'error', 'forgot');
                    return;
                }

                this.setForgotPasswordLoading(true);
                this.showMessage('Os guardas estão enviando uma nova palavra secreta...', 'loading', 'forgot');
                
                try {
                    // Importar o supabaseAuth dinamicamente
                    const { supabaseAuth } = await import('./src/core/supabase.js');
                    
                    const result = await supabaseAuth.resetPassword(email);
                    
                    if (result.success) {
                        this.showMessage(`📧 Nova palavra enviada para ${email}!\n\nVerifique sua caixa de entrada e siga as instruções dos guardas.`, 'success', 'forgot');
                        
                        // Chamar reação dos guardas ao sucesso
                        if (window.loginGuards) {
                            window.loginGuards.onForgotPasswordSuccess(email);
                        }
                        
                        // Limpar formulário
                        this.forgotEmailInput.value = '';
                        
                        // Após 5 segundos, voltar para login
                        setTimeout(() => {
                            this.switchToLogin();
                            this.showMessage('Use o link do email para criar uma nova palavra!', 'success');
                        }, 5000);
                    } else {
                        this.showMessage(result.message || 'Email não encontrado nos pergaminhos do reino!', 'error', 'forgot');
                        
                        // Chamar reação dos guardas ao erro
                        if (window.loginGuards) {
                            window.loginGuards.onForgotPasswordError();
                        }
                    }
                } catch (error) {
                    console.error('Erro no esqueceu senha:', error);
                    this.showMessage('Erro de conexão com os guardas. Tente novamente.', 'error', 'forgot');
                } finally {
                    this.setForgotPasswordLoading(false);
                }
            }

            setForgotPasswordLoading(isLoading) {
                this.forgotPasswordButton.disabled = isLoading;
                
                if (isLoading) {
                    this.forgotPasswordButton.innerHTML = `
                        <span class="loading-spinner"></span>
                        Enviando...
                    `;
                } else {
                    this.forgotPasswordButton.innerHTML = `
                        <i class="fas fa-paper-plane"></i>
                        Enviar Nova Palavra
                    `;
                }
            }
        }

        // Inicializar quando DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            new LoginPageAuth();
        });
    </script>-->

    <!-- Sistema de guardas interativos - Baseado no companion -->
    <script>
        class LoginGuards {
            constructor() {
                this.leftGuard = document.querySelector('.left-guard');
                this.rightGuard = document.querySelector('.right-guard');
                this.leftGuardAvatar = document.getElementById('leftGuardAvatar');
                this.rightGuardAvatar = document.getElementById('rightGuardAvatar');
                this.leftSpeechBubble = this.leftGuard?.querySelector('.guard-speech-bubble');
                this.rightSpeechBubble = this.rightGuard?.querySelector('.guard-speech-bubble');
                this.leftGuardText = document.getElementById('leftGuardText');
                this.rightGuardText = document.getElementById('rightGuardText');
                
                this.leftLastMessage = '';
                this.rightLastMessage = '';
                this.leftHideTimeout = null;
                this.rightHideTimeout = null;
                this.leftAvatarTimeout = null;
                this.rightAvatarTimeout = null;

                // Garantir que os guardas comecem visíveis
                if (this.leftGuard) {
                    this.leftGuard.style.opacity = '1';
                }
                if (this.rightGuard) {
                    this.rightGuard.style.opacity = '1';
                }

                // No mobile, começar com speech bubbles e avatares no estado inicial
                if (window.innerWidth < 1023) {
                    if (this.leftSpeechBubble) {
                        this.leftSpeechBubble.classList.add('hidden');
                    }
                    if (this.rightSpeechBubble) {
                        this.rightSpeechBubble.classList.add('hidden');
                    }
                    // Avatares começam visíveis, mas serão escondidos após inatividade
                    if (this.leftGuardAvatar) {
                        this.leftGuardAvatar.classList.add('avatar-show');
                    }
                    if (this.rightGuardAvatar) {
                        this.rightGuardAvatar.classList.add('avatar-show');
                    }
                }
                
                this.leftMessages = [
                    "Alto, viajante! Identificação necessária para prosseguir.",
                    "Estado seu nome e propósito neste reino!",
                    "Por ordem real, todos devem se identificar.",
                    "Suas credenciais, aventureiro!",
                    "O reino deve conhecer quem cruza nossos portões."
                ];
                
                this.rightMessages = [
                    "Os portões do Reino aguardam sua passagem autorizada.",
                    "Apresente seus documentos de viagem!",
                    "Nenhum estranho passa sem identificação.",
                    "Prove sua identidade, forasteiro!",
                    "A segurança do reino é nossa prioridade."
                ];
                
                this.errorMessages = [
                    "Credenciais inválidas! Tente novamente, impostor!",
                    "Esse não é um nome reconhecido em nossos pergaminhos!",
                    "Palavra de reconhecimento incorreta, intruso!",
                    "Por Khalmyr! Essas não são as credenciais certas!",
                    "Alto aí! Esses dados não conferem com nossos registros!"
                ];
                
                this.successMessages = [
                    "Bem-vindo ao reino, nobre aventureiro!",
                    "Passagem autorizada! Que a fortuna te acompanhe!",
                    "Credenciais aprovadas. Os portões se abrem para você!",
                    "Entrada concedida! Que sua jornada seja próspera!",
                    "Bem-vindo de volta ao Forjador de Lendas!"
                ];
                
                this.registerMessages = [
                    "Interessado em se juntar ao reino? Excelente escolha!",
                    "Novos aventureiros são sempre bem-vindos aqui!",
                    "Vamos registrar suas informações nos pergaminhos oficiais.",
                    "Prepare-se para se tornar um membro oficial do reino!",
                    "O reino sempre precisa de novos heróis corajosos!"
                ];

                this.registerSuccessMessages = [
                    "Registro aprovado! Bem-vindo ao reino, aventureiro!",
                    "Pergaminhos assinados! Você agora é um de nós!",
                    "Parabéns! Seu nome foi inscrito no livro de honra!",
                    "Registro concluído! Que sua jornada seja lendária!",
                    "Bem-vindo à nossa irmandade de aventureiros!"
                ];

                this.registerErrorMessages = [
                    "Algo deu errado com o registro. Verifique os dados!",
                    "Este nome já consta em nossos pergaminhos!",
                    "Os documentos não foram preenchidos corretamente!",
                    "Registro negado! Verifique as informações fornecidas.",
                    "Erro nos pergaminhos! Tente preencher novamente."
                ];

                this.forgotPasswordMessages = [
                    "Esqueceu sua palavra de reconhecimento? Sem problemas!",
                    "Nossos correios podem enviar uma nova palavra secreta!",
                    "Informe o endereço registrado nos pergaminhos do reino.",
                    "Os guardas da torre de mensagens estão prontos para ajudar!",
                    "Uma nova palavra será forjada especialmente para você!"
                ];

                this.forgotPasswordSuccessMessages = [
                    "Pergaminho enviado! Verifique seu correio, aventureiro!",
                    "Nova palavra secreta despachada pelos nossos pombos-correio!",
                    "Mensagem dos guardas enviada! Siga as instruções do email.",
                    "Os escribas enviaram sua nova palavra de reconhecimento!",
                    "Correio real despachado! Sua nova chave chegará em breve!"
                ];

                this.forgotPasswordErrorMessages = [
                    "Este endereço não consta em nossos pergaminhos!",
                    "Erro no sistema de correios! Tente novamente.",
                    "Email não reconhecido pelos arquivistas do reino!",
                    "Falha na entrega! Verifique o endereço informado.",
                    "Os pombos-correio não encontraram este destino!"
                ];
                
                this.setupEventListeners();
                this.setupMobileEvents();
                this.setupScrollListener();
                this.greet();
            }
            
            setupEventListeners() {
                // Eventos do formulário de login
                const usernameInput = document.getElementById('username');
                const passwordInput = document.getElementById('password');
                
                if (usernameInput) {
                    usernameInput.addEventListener('input', () => this.onUsernameInput());
                }
                
                if (passwordInput) {
                    passwordInput.addEventListener('input', () => this.onPasswordInput());
                }

                // Eventos do formulário de registro
                const regUsernameInput = document.getElementById('regUsername');
                const regEmailInput = document.getElementById('regEmail');
                const regPasswordInput = document.getElementById('regPassword');
                
                if (regUsernameInput) {
                    regUsernameInput.addEventListener('input', () => this.onRegUsernameInput());
                }
                
                if (regEmailInput) {
                    regEmailInput.addEventListener('input', () => this.onRegEmailInput());
                }
                
                if (regPasswordInput) {
                    regPasswordInput.addEventListener('input', () => this.onRegPasswordInput());
                }
            }

            setupMobileEvents() {
                if (this.leftGuardAvatar) {
                    this.leftGuardAvatar.addEventListener('click', () => {
                        if (window.innerWidth < 1023) {
                            if (this.leftSpeechBubble && this.leftSpeechBubble.classList.contains('hidden')) {
                                this.showLastMessage('left');
                            } else {
                                this.hideSpeechBubble('left');
                            }
                        }
                    });
                }
                
                if (this.rightGuardAvatar) {
                    this.rightGuardAvatar.addEventListener('click', () => {
                        if (window.innerWidth < 1023) {
                            if (this.rightSpeechBubble && this.rightSpeechBubble.classList.contains('hidden')) {
                                this.showLastMessage('right');
                            } else {
                                this.hideSpeechBubble('right');
                            }
                        }
                    });
                }
                
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 1023) {
                        if (!this.leftGuardAvatar?.contains(e.target) &&
                            this.leftSpeechBubble && !this.leftSpeechBubble.contains(e.target) &&
                            !this.leftSpeechBubble.classList.contains('hidden')) {
                            this.hideSpeechBubble('left');
                        }
                        
                        if (!this.rightGuardAvatar?.contains(e.target) &&
                            this.rightSpeechBubble && !this.rightSpeechBubble.contains(e.target) &&
                            !this.rightSpeechBubble.classList.contains('hidden')) {
                            this.hideSpeechBubble('right');
                        }
                    }
                });
            }

            setupScrollListener() {
                let isNearBottom = false;
                const threshold = 150; // Aumentado para dar mais espaço

                const checkFooterPosition = () => {
                    if (window.innerWidth >= 1023) return;

                    const scrollPosition = window.scrollY;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    const distanceFromBottom = documentHeight - (scrollPosition + windowHeight);

                    // Se o documento é menor que a viewport, não precisa esconder
                    if (documentHeight <= windowHeight + 50) {
                        if (isNearBottom) {
                            if (this.leftGuard) this.leftGuard.classList.remove('guard-fade-out');
                            if (this.rightGuard) this.rightGuard.classList.remove('guard-fade-out');
                            isNearBottom = false;
                        }
                        return;
                    }

                    if (distanceFromBottom <= threshold) {
                        if (!isNearBottom) {
                            if (this.leftGuard) this.leftGuard.classList.add('guard-fade-out');
                            if (this.rightGuard) this.rightGuard.classList.add('guard-fade-out');
                            isNearBottom = true;
                        }
                    } else {
                        if (isNearBottom) {
                            if (this.leftGuard) this.leftGuard.classList.remove('guard-fade-out');
                            if (this.rightGuard) this.rightGuard.classList.remove('guard-fade-out');
                            isNearBottom = false;
                        }
                    }
                };

                // Verifica no scroll
                window.addEventListener('scroll', checkFooterPosition, { passive: true });

                // Verifica no carregamento
                checkFooterPosition();

                // Verifica também no redimensionamento
                window.addEventListener('resize', checkFooterPosition);
            }
            
            speak(guard, text, duration = null) {
                const guardContainer = guard === 'left' ? this.leftGuard : this.rightGuard;
                const speechBubble = guard === 'left' ? this.leftSpeechBubble : this.rightSpeechBubble;
                const textElement = guard === 'left' ? this.leftGuardText : this.rightGuardText;
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                
                if (!speechBubble || !textElement) return;
                
                // Remove fade out
                if (guardContainer) {
                    guardContainer.classList.remove('guard-fade-out');
                }

                // Salva última mensagem
                if (guard === 'left') {
                    this.leftLastMessage = text;
                } else {
                    this.rightLastMessage = text;
                }
                
                // Limpa qualquer timeout anterior (speech bubble e avatar)
                if (guard === 'left' && this.leftHideTimeout) {
                    clearTimeout(this.leftHideTimeout);
                    this.leftHideTimeout = null;
                }
                if (guard === 'right' && this.rightHideTimeout) {
                    clearTimeout(this.rightHideTimeout);
                    this.rightHideTimeout = null;
                }

                // No mobile, mostra o avatar quando há nova interação
                if (window.innerWidth < 1023) {
                    this.showAvatar(guard);
                }

                // Mostra o speech bubble
                speechBubble.classList.remove('hidden', 'auto-hide');
                speechBubble.classList.add('show', 'fade-in');
                textElement.textContent = text;
                
                if (window.innerWidth <= 768) {
                    // Em mobile, pisca o avatar quando fala
                    if (avatar) {
                    avatar.style.boxShadow = '0 0 15px var(--accent-color)';
                    setTimeout(() => {
                        avatar.style.boxShadow = '';
                    }, 1000);
                    }
                }

                // No mobile, esconde automaticamente após um tempo
                if (window.innerWidth < 1023) {
                    const autoHideDuration = duration || 4000; // 4 segundos padrão
                    const timeoutId = setTimeout(() => {
                        this.autoHideSpeechBubble(guard);
                    }, autoHideDuration);

                    if (guard === 'left') {
                        this.leftHideTimeout = timeoutId;
                    } else {
                        this.rightHideTimeout = timeoutId;
                    }
                } else if (duration) {
                    setTimeout(() => this.hideSpeechBubble(guard), duration);
                }
            }

            hideSpeechBubble(guard) {
                const speechBubble = guard === 'left' ? this.leftSpeechBubble : this.rightSpeechBubble;
                if (speechBubble) {
                    speechBubble.classList.remove('show', 'fade-in');
                    speechBubble.classList.add('hidden');
                }
            }
            
            autoHideSpeechBubble(guard) {
                const speechBubble = guard === 'left' ? this.leftSpeechBubble : this.rightSpeechBubble;
                if (speechBubble && window.innerWidth < 1023) {
                    speechBubble.classList.remove('show', 'fade-in');
                    speechBubble.classList.add('auto-hide');
                    
                    // Após a transição, adiciona hidden
                    setTimeout(() => {
                        if (speechBubble.classList.contains('auto-hide')) {
                            speechBubble.classList.remove('auto-hide');
                            speechBubble.classList.add('hidden');
                        }
                    }, 800); // Tempo da transição + delay

                    // Inicia timeout para esconder avatar após mais tempo
                    this.startAvatarHideTimeout(guard);
                }
            }

            showAvatar(guard) {
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                if (avatar && window.innerWidth < 1023) {
                    // Cancela timeout de esconder avatar se existir
                    if (guard === 'left' && this.leftAvatarTimeout) {
                        clearTimeout(this.leftAvatarTimeout);
                        this.leftAvatarTimeout = null;
                    }
                    if (guard === 'right' && this.rightAvatarTimeout) {
                        clearTimeout(this.rightAvatarTimeout);
                        this.rightAvatarTimeout = null;
                    }

                    avatar.classList.remove('avatar-hidden', 'avatar-auto-hide');
                    avatar.classList.add('avatar-show');
                }
            }

            hideAvatar(guard) {
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                if (avatar && window.innerWidth < 1023) {
                    avatar.classList.remove('avatar-show');
                    avatar.classList.add('avatar-hidden');
                }
            }

            autoHideAvatar(guard) {
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                if (avatar && window.innerWidth < 1023) {
                    avatar.classList.remove('avatar-show');
                    avatar.classList.add('avatar-auto-hide');
                    
                    // Após a transição, adiciona hidden
                    setTimeout(() => {
                        if (avatar.classList.contains('avatar-auto-hide')) {
                            avatar.classList.remove('avatar-auto-hide');
                            avatar.classList.add('avatar-hidden');
                        }
                    }, 1100); // Tempo da transição + delay
                }
            }

            startAvatarHideTimeout(guard) {
                const inactivityDuration = 8000; // 8 segundos após speech bubble desaparecer
                const timeoutId = setTimeout(() => {
                    this.autoHideAvatar(guard);
                }, inactivityDuration);

                if (guard === 'left') {
                    this.leftAvatarTimeout = timeoutId;
                } else {
                    this.rightAvatarTimeout = timeoutId;
                }
            }
            
            greet() {
                // Saudação inicial alternada
                setTimeout(() => {
                    const duration = window.innerWidth < 1023 ? 3000 : null; // 3 segundos no mobile
                    this.speak('left', this.leftMessages[0], duration);
                }, 500);
                
                setTimeout(() => {
                    const duration = window.innerWidth < 1023 ? 3000 : null; // 3 segundos no mobile
                    this.speak('right', this.rightMessages[0], duration);
                }, 2000);

                // No mobile, inicia timeout de inatividade total após as saudações
                if (window.innerWidth < 1023) {
                    setTimeout(() => {
                        this.startInitialInactivityTimeout();
                    }, 8000); // 8 segundos após as saudações iniciais
                }
            }

            startInitialInactivityTimeout() {
                // Timeout para esconder avatares se não houver interação
                const totalInactivityDuration = 15000; // 15 segundos de inatividade total
                
                this.leftAvatarTimeout = setTimeout(() => {
                    this.autoHideAvatar('left');
                }, totalInactivityDuration);
                
                this.rightAvatarTimeout = setTimeout(() => {
                    this.autoHideAvatar('right');
                }, totalInactivityDuration);
            }
            
            onUsernameInput() {
                const username = document.getElementById('username')?.value.trim();
                if (username && username.length > 2) {
                    const responses = [
                        `${username}? Verificando nos registros...`,
                        `Nome anotado: ${username}. Aguardo a palavra de reconhecimento.`,
                        `${username}... *consulta pergaminho* Prossiga com a identificação.`
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('left', responses[Math.floor(Math.random() * responses.length)], duration);
                }
            }
            
            onPasswordInput() {
                const messages = [
                    "Palavra de reconhecimento em análise...",
                    "Verificando autorização...",
                    "*Examina cuidadosamente os códigos*"
                ];
                const duration = window.innerWidth < 1023 ? 3500 : null;
                this.speak('right', messages[Math.floor(Math.random() * messages.length)], duration);
            }

            // Métodos de reação para campos de registro
            onRegUsernameInput() {
                const username = document.getElementById('regUsername')?.value.trim();
                if (username && username.length > 2) {
                    const responses = [
                        `${username}? Um nome digno de um aventureiro!`,
                        `Anotando "${username}" nos pergaminhos...`,
                        `${username}... *escreve cuidadosamente* Nome registrado!`,
                        `Bom nome de aventureiro! Prossiga com o cadastro.`
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('left', responses[Math.floor(Math.random() * responses.length)], duration);
                }
            }

            onRegEmailInput() {
                const email = document.getElementById('regEmail')?.value.trim();
                if (email && email.includes('@')) {
                    const messages = [
                        "Correio do reino anotado nos registros!",
                        "Endereço válido! Prossiga com o cadastro.",
                        "*Anota o endereço no pergaminho oficial*",
                        "Correio registrado para comunicações futuras!"
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('right', messages[Math.floor(Math.random() * messages.length)], duration);
                }
            }

            onRegPasswordInput() {
                const password = document.getElementById('regPassword')?.value;
                if (password && password.length >= 4) {
                    const messages = [
                        "Palavra secreta sendo cifrada...",
                        "*Codifica a palavra nos pergaminhos secretos*",
                        "Força da palavra: " + (password.length >= 8 ? "Excelente!" : "Adequada."),
                        "Palavra de reconhecimento em processamento..."
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('left', messages[Math.floor(Math.random() * messages.length)], duration);
                }
            }

            // Função para mostrar última mensagem (mobile)
            showLastMessage(guard) {
                const lastMessage = guard === 'left' ? this.leftLastMessage : this.rightLastMessage;
                const guardContainer = guard === 'left' ? this.leftGuard : this.rightGuard;
                
                if (lastMessage) {
                    if (guardContainer) {
                        guardContainer.classList.remove('guard-fade-out');
                    }
                    // Mostra avatar também quando clica para ver última mensagem
                    if (window.innerWidth < 1023) {
                        this.showAvatar(guard);
                    }
                    this.speak(guard, lastMessage);
                }
            }

            // Método para ser chamado pelo sistema de login
            onLoginSuccess() {
                    const successMessage = this.successMessages[Math.floor(Math.random() * this.successMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', successMessage, duration);
                    
                    setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Portões abertos! Bem-vindo ao reino!", duration2);
                    }, 1000);
            }

            onLoginError() {
                const errorMessage = this.errorMessages[Math.floor(Math.random() * this.errorMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', errorMessage, duration);
                
                    setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Tente novamente, mas com as credenciais corretas!", duration2);
                }, 1500);
            }

            // Métodos para registro
            onSwitchToRegister() {
                const registerMessage = this.registerMessages[Math.floor(Math.random() * this.registerMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', registerMessage, duration);
                    
                    setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Preencha o formulário com suas informações!", duration2);
                }, 1000);
            }

            onSwitchToLogin() {
                const duration = window.innerWidth < 1023 ? 3000 : null;
                this.speak('left', "De volta ao reconhecimento! Informe suas credenciais.", duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 3000 : null;
                    this.speak('right', "Apresente sua identificação para entrar!", duration2);
                }, 1000);
            }

            onRegisterSuccess(username) {
                const successMessage = this.registerSuccessMessages[Math.floor(Math.random() * this.registerSuccessMessages.length)];
                const duration = window.innerWidth < 1023 ? 5000 : null;
                this.speak('left', successMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 5000 : null;
                    this.speak('right', `${username}, agora faça login para acessar o reino!`, duration2);
                    }, 1500);
                }

            onRegisterError() {
                const errorMessage = this.registerErrorMessages[Math.floor(Math.random() * this.registerErrorMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', errorMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Corrija os dados e tente registrar novamente!", duration2);
                }, 1500);
            }

            // Métodos para esqueceu senha
            onSwitchToForgotPassword() {
                const forgotMessage = this.forgotPasswordMessages[Math.floor(Math.random() * this.forgotPasswordMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', forgotMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Digite seu email e enviaremos uma nova palavra!", duration2);
                }, 1000);
            }

            onForgotPasswordSuccess(email) {
                const successMessage = this.forgotPasswordSuccessMessages[Math.floor(Math.random() * this.forgotPasswordSuccessMessages.length)];
                const duration = window.innerWidth < 1023 ? 5000 : null;
                this.speak('left', successMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 5000 : null;
                    this.speak('right', `Nova palavra enviada para ${email}! Verifique sua caixa de entrada.`, duration2);
                }, 1500);
            }

            onForgotPasswordError() {
                const errorMessage = this.forgotPasswordErrorMessages[Math.floor(Math.random() * this.forgotPasswordErrorMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', errorMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Verifique o email e tente novamente!", duration2);
                }, 1500);
            }
        }
        
        // Inicializar guardas quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            window.loginGuards = new LoginGuards();
        });
    </script>
</body>
</html> 