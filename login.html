<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reconhecimento dos Guardas - Forjador de Lendas</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    
    <!-- Reset CSS -->
    <link rel="stylesheet" href="css/reset.css">
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    <!-- CSS do projeto -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/login-guards.css">
    
    <style>
        /* Estilos espec√≠ficos para p√°gina de login */
        body {
            height: 100vh;
            overflow: hidden;
            /* Background medieval espec√≠fico para login */
            background-image: url('assets/img/bg-login.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
        }

        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            position: relative;
            z-index: 10; /* Bem acima dos guardas */
        }

        .guard-castle {
            background-color: var(--panel-bg);
            border: 2px solid var(--panel-border);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            max-width: 450px;
            width: 100%;
            padding: 2rem;
            position: relative;
            color: var(--text-color);
            backdrop-filter: blur(2px); /* Adiciona leve desfoque no fundo */
        }

        .castle-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .castle-title {
            font-family: 'MedievalSharp', cursive;
            color: var(--accent-color);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .castle-subtitle {
            color: var(--text-color);
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .guard-avatars {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
        }

        .guard-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
            border: 2px solid var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            font-size: 1.2rem;
            animation: guardWatch 4s ease-in-out infinite;
        }

        .guard-avatar:nth-child(2) {
            animation-delay: -1s;
        }

        .guard-avatar:nth-child(3) {
            animation-delay: -2s;
        }

        @keyframes guardWatch {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.05) rotate(-3deg); }
            75% { transform: scale(1.05) rotate(3deg); }
        }

        .guard-message {
            background-color: rgba(35, 25, 15, 0.6);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
            position: relative;
        }

        .guard-message p {
            color: var(--text-color);
            font-size: 0.95rem;
            line-height: 1.5;
            margin: 0;
        }

        .guard-message p strong {
            color: var(--accent-color);
            font-weight: 700;
        }

        .field-group {
            margin-bottom: 1rem;
        }

        .field-label {
            display: block;
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left; /* Centraliza as labels */
        }

        .field-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: rgba(35, 25, 15, 0.8);
            border: 2px solid var(--panel-border);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .field-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
            background-color: var(--panel-bg);
        }

        .field-input::placeholder {
            color: rgba(232, 219, 190, 0.6);
        }

        .input-container {
            position: relative;
        }

        .field-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
            font-size: 1rem;
        }

        .remember-guards {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .custom-checkbox {
            width: 18px;
            height: 18px;
            position: relative;
            cursor: pointer;
            display: inline-block;
        }

        .custom-checkbox input {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 2; /* Garante que o input est√° acima do checkmark */
        }

        .custom-checkbox input:checked + .checkmark {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .custom-checkbox input:checked + .checkmark::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--secondary-color);
            font-weight: bold;
            font-size: 12px;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(35, 25, 15, 0.8);
            border: 2px solid var(--panel-border);
            border-radius: 3px;
            transition: all 0.3s ease;
            z-index: 1; /* Atr√°s do input */
        }

        .custom-checkbox:hover .checkmark {
            border-color: var(--accent-color);
            background-color: rgba(212, 175, 55, 0.1);
        }

        .remember-text {
            color: var(--text-color);
            font-size: 0.85rem;
            cursor: pointer;
        }

        .guard-button {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(145deg, var(--accent-color), #b8941f);
            border: none;
            border-radius: 6px;
            color: var(--secondary-color);
            font-weight: 700;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem 0;
        }

        .guard-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }

        .guard-button:active {
            transform: translateY(0);
        }

        .guard-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-message {
            margin-top: 0.5rem;
            padding: 0.75rem;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: none;
        }

        .status-message.success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
            display: block;
        }

        .status-message.error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
            display: block;
        }

        .status-message.loading {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #2196f3;
            display: block;
        }

        .castle-footer {
            text-align: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
        }

        .footer-text {
            color: var(--text-color);
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .footer-link {
            color: var(--accent-color);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer-link:hover {
            color: #ffd700;
        }



        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Sistema de altern√¢ncia entre login e registro */
        .auth-card {
            opacity: 1;
            transform: translateX(0);
            transition: all 0.5s ease;
        }

        .auth-card.hidden {
            opacity: 0;
            transform: translateX(-20px);
            pointer-events: none;
                position: absolute;
            top: 0;
                left: 0;
                right: 0;
            }

        .auth-card.slide-out-left {
                opacity: 0;
            transform: translateX(-100%);
        }

        .auth-card.slide-in-right {
            opacity: 1;
            transform: translateX(0);
            }
            
            .guard-castle {
            position: relative;
            overflow: hidden;
        }

        /* Ajustes espec√≠ficos para mobile */
        @media (max-width: 1023px) {
            .login-container {
                /* Mant√©m centraliza√ß√£o por padr√£o (modo login) */
                align-items: center;
                padding: 1rem;
            }
            
            .guard-castle {
                width: 100%;
                max-width: 400px;
                margin: 0 auto;
            }
            
            /* Quando formul√°rio de registro est√° ativo, permite scroll */
            .login-container:has(#registerCard:not(.hidden)) {
                align-items: flex-start; /* S√≥ alinha ao topo no registro */
                min-height: auto; /* Remove altura fixa */
                padding-top: 2rem;
                padding-bottom: 4rem;
            }
        }

        /* Fallback para navegadores que n√£o suportam :has() */
        @media (max-width: 1023px) {
            .login-container.register-mode {
                min-height: auto !important;
                align-items: flex-start !important;
                padding-top: 2rem !important;
                padding-bottom: 4rem !important;
            }
            
            /* Modo login expl√≠cito (quando n√£o est√° em register-mode) */
            .login-container:not(.register-mode) {
                align-items: center !important;
                padding: 1rem !important;
                min-height: 100vh !important;
            }
        }


    </style>
</head>
<body class="no-js">
    <script>document.body.classList.remove('no-js');</script>

    <!-- Overlay de n√©voa mais sutil para login -->
    <div class="fog-overlay" style="opacity: 0.05;"></div>

    <!-- Guardas laterais -->
    <div class="left-guard">
        <div class="guard-speech-bubble hidden">
            <p id="leftGuardText">Alto, viajante! Identifica√ß√£o necess√°ria para prosseguir.</p>
        </div>
        <img src="assets/img/guarda-1.png" alt="Guarda Esquerdo" class="guard-image" id="leftGuardAvatar">
    </div>
    <div class="right-guard">
        <div class="guard-speech-bubble hidden">
            <p id="rightGuardText">Os port√µes do Reino aguardam sua passagem autorizada.</p>
        </div>
        <img src="assets/img/guarda-2.png" alt="Guarda Direito" class="guard-image" id="rightGuardAvatar">
    </div>

    <div class="login-container">
        <div class="guard-castle">
            <!-- Login Card -->
            <div id="loginCard" class="auth-card">
            <div class="castle-header">
                <h1 class="castle-title">
                    <i class="fas fa-shield-alt"></i>
                    Reconhecimento
                </h1>
            </div>

            <div class="guard-message">
                <p>
                    <strong>Alto l√°, viajante!</strong><br>
                    Nossos guardas precisam verificar sua identidade antes de permitir 
                    o acesso aos segredos do Forjador de Lendas. Identifique-se!
                </p>
            </div>

            <form id="recognitionForm" class="recognition-form">
                <div class="field-group">
                    <label class="field-label" for="username">
                        <i class="fas fa-user"></i>
                        Nome do Aventureiro
                    </label>
                    <div class="input-container">
                        <input 
                            type="text" 
                            id="username" 
                            class="field-input"
                            placeholder="Digite seu nome de usu√°rio"
                            required
                            autocomplete="username"
                        >
                        <i class="fas fa-user field-icon"></i>
                    </div>
                </div>

                <div class="field-group">
                    <label class="field-label" for="password">
                        <i class="fas fa-key"></i>
                        Palavra de Reconhecimento
                    </label>
                    <div class="input-container">
                        <input 
                            type="password" 
                            id="password" 
                            class="field-input"
                            placeholder="Digite sua palavra secreta"
                            required
                            autocomplete="current-password"
                        >
                        <i class="fas fa-lock field-icon"></i>
                    </div>
                </div>

                <div class="remember-guards">
                    <div class="custom-checkbox">
                        <input type="checkbox" id="rememberMe">
                        <span class="checkmark"></span>
                    </div>
                    <label for="rememberMe" class="remember-text">
                        Lembrar desta jornada pelos pr√≥ximos 30 dias
                    </label>
                </div>

                <button type="submit" class="guard-button" id="submitButton">
                    <i class="fas fa-dungeon"></i>
                    Passar pelos Guardas
                </button>

                <div id="statusMessage" class="status-message"></div>
            </form>

            <div class="castle-footer">
                <p class="footer-text">
                    Primeiro acesso? <a href="#" class="footer-link" id="registerLink">Solicite passagem aos guardas</a>
                </p>
                <p class="footer-text" style="margin-top: 0.3rem;">
                    <a href="#" class="footer-link" id="forgotPasswordLink">Esqueceu sua palavra de reconhecimento?</a>
                </p>
                </div>
            </div>

            <!-- Forgot Password Card -->
            <div id="forgotPasswordCard" class="auth-card hidden">
                <div class="castle-header">
                    <h1 class="castle-title">
                        <i class="fas fa-key"></i>
                        Recuperar Palavra
                    </h1>
                </div>

                <div class="guard-message">
                    <p>
                        <strong>Esqueceu sua palavra de reconhecimento?</strong><br>
                        Nossos guardas podem enviar uma nova palavra secreta para seu correio. 
                        Informe o endere√ßo registrado nos pergaminhos do reino.
                    </p>
                </div>

                <form id="forgotPasswordForm" class="recognition-form">
                    <div class="field-group">
                        <label class="field-label" for="forgotEmail">
                            <i class="fas fa-envelope"></i>
                            Correio do Reino
                        </label>
                        <div class="input-container">
                            <input 
                                type="email" 
                                id="forgotEmail" 
                                class="field-input"
                                placeholder="seu.email@reino.com"
                                required
                                autocomplete="email"
                            >
                            <i class="fas fa-envelope field-icon"></i>
                        </div>
                    </div>

                    <button type="submit" class="guard-button" id="forgotPasswordButton">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Nova Palavra
                    </button>

                    <div id="forgotPasswordStatusMessage" class="status-message"></div>
                </form>

                <div class="castle-footer">
                    <p class="footer-text">
                        Lembrou da palavra? <a href="#" class="footer-link" id="backToLoginLink">Retornar ao reconhecimento</a>
                    </p>
                </div>
            </div>

            <!-- Register Card -->
            <div id="registerCard" class="auth-card hidden">
                <div class="castle-header">
                    <h1 class="castle-title">
                        <i class="fas fa-scroll"></i>
                        Registro de Aventureiro
                    </h1>
                </div>

                <div class="guard-message">
                    <p>
                        <strong>Bem-vindo, futuro aventureiro!</strong><br>
                        Para se tornar um membro do reino, nossos guardas precisam 
                        registrar suas informa√ß√µes nos pergaminhos oficiais.
                    </p>
                </div>

                <form id="registrationForm" class="recognition-form">
                    <div class="field-group">
                        <label class="field-label" for="regUsername">
                            <i class="fas fa-user"></i>
                            Nome do Aventureiro
                        </label>
                        <div class="input-container">
                            <input 
                                type="text" 
                                id="regUsername" 
                                class="field-input"
                                placeholder="Escolha seu nome de aventureiro"
                                required
                                autocomplete="username"
                            >
                            <i class="fas fa-user field-icon"></i>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label" for="regEmail">
                            <i class="fas fa-envelope"></i>
                            Correio do Reino
                        </label>
                        <div class="input-container">
                            <input 
                                type="email" 
                                id="regEmail" 
                                class="field-input"
                                placeholder="seu.email@reino.com"
                                required
                                autocomplete="email"
                            >
                            <i class="fas fa-envelope field-icon"></i>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label" for="regPassword">
                            <i class="fas fa-key"></i>
                            Palavra de Reconhecimento
                        </label>
                        <div class="input-container">
                            <input 
                                type="password" 
                                id="regPassword" 
                                class="field-input"
                                placeholder="Crie uma palavra secreta forte"
                                required
                                autocomplete="new-password"
                            >
                            <i class="fas fa-lock field-icon"></i>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label" for="regConfirmPassword">
                            <i class="fas fa-key"></i>
                            Confirmar Palavra
                        </label>
                        <div class="input-container">
                            <input 
                                type="password" 
                                id="regConfirmPassword" 
                                class="field-input"
                                placeholder="Digite novamente sua palavra secreta"
                                required
                                autocomplete="new-password"
                            >
                            <i class="fas fa-lock field-icon"></i>
                        </div>
                    </div>

                    <div class="remember-guards">
                        <div class="custom-checkbox">
                            <input type="checkbox" id="acceptTerms" required>
                            <span class="checkmark"></span>
                        </div>
                        <label for="acceptTerms" class="remember-text">
                            Aceito os termos do reino e o c√≥digo de honra dos aventureiros
                        </label>
                    </div>

                    <button type="submit" class="guard-button" id="registerButton">
                        <i class="fas fa-scroll"></i>
                        Registrar no Reino
                    </button>

                    <div id="registerStatusMessage" class="status-message"></div>
                </form>

                <div class="castle-footer">
                    <p class="footer-text">
                        J√° possui registro? <a href="#" class="footer-link" id="loginLink">Retornar ao reconhecimento</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="src/core/supabase.js"></script>
    <!-- <script type="module" src="js/login-manager.js"></script> Desabilitado - conflito com implementa√ß√£o nova -->
    <script type="module">
        // Sistema de autentica√ß√£o para p√°gina de login e registro
        class LoginPageAuth {
            constructor() {
                // Elementos do login
                this.loginCard = document.getElementById('loginCard');
                this.registerCard = document.getElementById('registerCard');
                this.forgotPasswordCard = document.getElementById('forgotPasswordCard');
                this.form = document.getElementById('recognitionForm');
                this.usernameInput = document.getElementById('username');
                this.passwordInput = document.getElementById('password');
                this.rememberInput = document.getElementById('rememberMe');
                this.submitButton = document.getElementById('submitButton');
                this.statusMessage = document.getElementById('statusMessage');
                
                // Elementos do registro
                this.registerForm = document.getElementById('registrationForm');
                this.regUsernameInput = document.getElementById('regUsername');
                this.regEmailInput = document.getElementById('regEmail');
                this.regPasswordInput = document.getElementById('regPassword');
                this.regConfirmPasswordInput = document.getElementById('regConfirmPassword');
                this.acceptTermsInput = document.getElementById('acceptTerms');
                this.registerButton = document.getElementById('registerButton');
                this.registerStatusMessage = document.getElementById('registerStatusMessage');
                
                // Elementos do esqueceu senha
                this.forgotPasswordForm = document.getElementById('forgotPasswordForm');
                this.forgotEmailInput = document.getElementById('forgotEmail');
                this.forgotPasswordButton = document.getElementById('forgotPasswordButton');
                this.forgotPasswordStatusMessage = document.getElementById('forgotPasswordStatusMessage');
                
                // Estado atual
                this.currentMode = 'login'; // 'login', 'register' ou 'forgot'
                
                this.init();
            }

            init() {
                // Verificar se j√° est√° logado
                this.checkExistingAuth();
                
                // Configurar event listeners para login
                this.form.addEventListener('submit', (e) => this.handleLogin(e));
                
                // Configurar event listeners para registro
                this.registerForm.addEventListener('submit', (e) => this.handleRegister(e));
                
                // Configurar event listeners para esqueceu senha
                this.forgotPasswordForm.addEventListener('submit', (e) => this.handleForgotPassword(e));
                
                // Links de altern√¢ncia entre login, registro e esqueceu senha
                document.getElementById('registerLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToRegister();
                });
                
                document.getElementById('loginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToLogin();
                });
                
                document.getElementById('backToLoginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToLogin();
                });
                
                document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.switchToForgotPassword();
                });

                // Auto-focus no campo de usu√°rio
                this.usernameInput.focus();
            }

            checkExistingAuth() {
                const token = localStorage.getItem('forjador_auth_token');
                const userData = localStorage.getItem('forjador_user_data');
                
                if (token && userData) {
                    try {
                        const user = JSON.parse(userData);
                        this.showMessage(`Bem-vindo de volta, ${user.username}! Redirecionando...`, 'success');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    } catch (error) {
                        console.error('Erro ao recuperar dados de auth:', error);
                        localStorage.removeItem('forjador_auth_token');
                        localStorage.removeItem('forjador_user_data');
                    }
                }
            }

            async handleLogin(event) {
                event.preventDefault();
                
                const username = this.usernameInput.value.trim();
                const password = this.passwordInput.value;
                const remember = this.rememberInput.checked;

                if (!username || !password) {
                    this.showMessage('Por favor, preencha todos os campos!', 'error');
                    return;
                }

                this.setLoading(true);
                this.showMessage('Os guardas est√£o verificando sua identidade...', 'loading');
                
                try {
                    const result = await this.authenticate(username, password);
                    
                    if (result.success) {
                        this.setAuthData(result.token, result.user, remember);
                        this.showMessage(`Acesso liberado! Bem-vindo, ${result.user.username}!`, 'success');
                        
                        // Definir mundo padr√£o se n√£o existir
                        if (!localStorage.getItem('selectedWorld')) {
                            localStorage.setItem('selectedWorld', 'tormenta'); // Tormenta como padr√£o
                        }
                        
                        // Chamar rea√ß√£o dos guardas ao sucesso
                        if (window.loginGuards) {
                            window.loginGuards.onLoginSuccess();
                        }
                        
                        setTimeout(() => {
                            // Verificar se h√° URL para redirecionar ap√≥s login
                            const redirectUrl = sessionStorage.getItem('forjador_redirect_after_login');
                            if (redirectUrl) {
                                sessionStorage.removeItem('forjador_redirect_after_login');
                                window.location.href = redirectUrl;
                            } else {
                            window.location.href = 'index.html';
                            }
                        }, 2000);
                    } else {
                        this.showMessage(result.message || 'Credenciais inv√°lidas! Os guardas n√£o reconhecem esta identidade.', 'error');
                        
                        // Chamar rea√ß√£o dos guardas ao erro
                        if (window.loginGuards) {
                            window.loginGuards.onLoginError();
                        }
                    }
                } catch (error) {
                    console.error('Erro no login:', error);
                    this.showMessage('Erro de conex√£o com os guardas. Tente novamente.', 'error');
                } finally {
                    this.setLoading(false);
                }
            }

            async authenticate(username, password) {
                // Simula√ß√£o - substituir por chamada real da API
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const validUsers = {
                            'admin': 'admin123',
                            'forjador': 'lendas123',
                            'mestre': 'rpg2024'
                        };

                        if (validUsers[username] === password) {
                            resolve({
                                success: true,
                                token: 'guard_token_' + Date.now(),
                                user: {
                                    id: Math.floor(Math.random() * 1000),
                                    username: username,
                                    email: `${username}@forjador.com`,
                                    role: username === 'admin' ? 'admin' : 'user',
                                    createdAt: new Date().toISOString()
                                }
                            });
                        } else {
                            resolve({
                                success: false,
                                message: 'Nome ou palavra de reconhecimento incorretos!'
                            });
                        }
                    }, 1500); // Simula delay de rede
                });
            }

            setAuthData(token, user, remember) {
                localStorage.setItem('forjador_auth_token', token);
                localStorage.setItem('forjador_user_data', JSON.stringify(user));
                
                if (remember) {
                    localStorage.setItem('forjador_remember_me', 'true');
                }
            }

            setLoading(isLoading) {
                this.submitButton.disabled = isLoading;
                
                if (isLoading) {
                    this.submitButton.innerHTML = `
                        <span class="loading-spinner"></span>
                        Verificando...
                    `;
                } else {
                    this.submitButton.innerHTML = `
                        <i class="fas fa-dungeon"></i>
                        Passar pelos Guardas
                    `;
                }
            }

            showMessage(message, type, target = 'login') {
                let messageElement;
                
                if (target === 'login') {
                    messageElement = this.statusMessage;
                } else if (target === 'register') {
                    messageElement = this.registerStatusMessage;
                } else if (target === 'forgot') {
                    messageElement = this.forgotPasswordStatusMessage;
                }
                
                if (!messageElement) return;
                
                messageElement.textContent = message;
                messageElement.className = `status-message ${type}`;
                messageElement.style.display = 'block';
                
                if (type === 'success' || type === 'error') {
                    setTimeout(() => {
                        if (type === 'error') {
                            messageElement.style.display = 'none';
                        }
                    }, 5000);
                }
            }

            switchToRegister() {
                this.currentMode = 'register';
                this.hideAllCards();
                this.registerCard.classList.remove('hidden');
                
                // Adiciona classe para ajustar layout mobile
                const container = document.querySelector('.login-container');
                if (container && window.innerWidth < 1023) {
                    container.classList.add('register-mode');
                    
                    // Garante que come√ßa do topo no mobile
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                // Informar guardas sobre mudan√ßa para registro
                if (window.loginGuards) {
                    window.loginGuards.onSwitchToRegister();
                }
                
                // Auto-focus no campo de usu√°rio do registro (delay maior para aguardar scroll)
                setTimeout(() => {
                    this.regUsernameInput.focus();
                }, 500);
            }

            switchToLogin() {
                this.currentMode = 'login';
                this.hideAllCards();
                this.loginCard.classList.remove('hidden');
                
                // Remove classe do modo registro
                const container = document.querySelector('.login-container');
                if (container) {
                    container.classList.remove('register-mode');
                }
                
                // No mobile, retorna scroll para o topo suavemente
                if (window.innerWidth < 1023) {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                // Informar guardas sobre mudan√ßa para login
                if (window.loginGuards) {
                    window.loginGuards.onSwitchToLogin();
                }
                
                // Auto-focus no campo de usu√°rio do login (delay maior para aguardar scroll)
                setTimeout(() => {
                    this.usernameInput.focus();
                }, 500);
            }

            switchToForgotPassword() {
                this.currentMode = 'forgot';
                this.hideAllCards();
                this.forgotPasswordCard.classList.remove('hidden');
                
                // Remove classe do modo registro se existir
                const container = document.querySelector('.login-container');
                if (container) {
                    container.classList.remove('register-mode');
                }
                
                // No mobile, vai para o topo
                if (window.innerWidth < 1023) {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
                
                // Informar guardas sobre mudan√ßa para esqueceu senha
                if (window.loginGuards) {
                    window.loginGuards.onSwitchToForgotPassword();
                }
                
                // Auto-focus no campo de email
                setTimeout(() => {
                    this.forgotEmailInput.focus();
                }, 500);
            }

            hideAllCards() {
                this.loginCard.classList.add('hidden');
                this.registerCard.classList.add('hidden');
                this.forgotPasswordCard.classList.add('hidden');
            }

            async handleRegister(event) {
                event.preventDefault();
                
                const username = this.regUsernameInput.value.trim();
                const email = this.regEmailInput.value.trim();
                const password = this.regPasswordInput.value;
                const confirmPassword = this.regConfirmPasswordInput.value;
                const acceptTerms = this.acceptTermsInput.checked;

                // Valida√ß√µes
                if (!username || !email || !password || !confirmPassword) {
                    this.showMessage('Por favor, preencha todos os campos!', 'error', 'register');
                    return;
                }

                if (password !== confirmPassword) {
                    this.showMessage('As palavras de reconhecimento n√£o coincidem!', 'error', 'register');
                    return;
                }

                if (password.length < 6) {
                    this.showMessage('A palavra de reconhecimento deve ter pelo menos 6 caracteres!', 'error', 'register');
                    return;
                }

                if (!acceptTerms) {
                    this.showMessage('Voc√™ deve aceitar os termos do reino para prosseguir!', 'error', 'register');
                    return;
                }

                this.setRegisterLoading(true);
                this.showMessage('Os guardas est√£o processando seu registro...', 'loading', 'register');
                
                try {
                    const result = await this.registerUser(username, email, password);
                    
                    if (result.success) {
                        this.showMessage(`Registro aprovado! Bem-vindo ao reino, ${username}!`, 'success', 'register');
                        
                        // Chamar rea√ß√£o dos guardas ao sucesso
                        if (window.loginGuards) {
                            window.loginGuards.onRegisterSuccess(username);
                        }
                        
                        // Ap√≥s 2 segundos, trocar para login
                        setTimeout(() => {
                            this.switchToLogin();
                            this.usernameInput.value = username;
                            this.showMessage('Agora fa√ßa login com suas credenciais!', 'success');
                        }, 2500);
                    } else {
                        this.showMessage(result.message || 'Erro ao processar registro. Tente novamente.', 'error', 'register');
                        
                        // Chamar rea√ß√£o dos guardas ao erro
                        if (window.loginGuards) {
                            window.loginGuards.onRegisterError();
                        }
                    }
                } catch (error) {
                    console.error('Erro no registro:', error);
                    this.showMessage('Erro de conex√£o com os guardas. Tente novamente.', 'error', 'register');
                } finally {
                    this.setRegisterLoading(false);
                }
            }

            async registerUser(username, email, password) {
                // Simula√ß√£o - substituir por chamada real da API
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Simular verifica√ß√£o de usu√°rio existente
                        const existingUsers = ['admin', 'forjador', 'mestre'];
                        
                        if (existingUsers.includes(username.toLowerCase())) {
                            resolve({
                                success: false,
                                message: 'Este nome de aventureiro j√° est√° registrado no reino!'
                            });
                        } else if (username.length < 3) {
                            resolve({
                                success: false,
                                message: 'O nome do aventureiro deve ter pelo menos 3 caracteres!'
                            });
                        } else {
                            resolve({
                                success: true,
                                message: 'Registro realizado com sucesso!'
                            });
                        }
                    }, 2000); // Simula delay de rede
                });
            }

            setRegisterLoading(isLoading) {
                this.registerButton.disabled = isLoading;
                
                if (isLoading) {
                    this.registerButton.innerHTML = `
                        <span class="loading-spinner"></span>
                        Processando...
                    `;
                } else {
                    this.registerButton.innerHTML = `
                        <i class="fas fa-scroll"></i>
                        Registrar no Reino
                    `;
                }
            }

            async handleForgotPassword(event) {
                event.preventDefault();
                
                const email = this.forgotEmailInput.value.trim();

                if (!email) {
                    this.showMessage('Por favor, informe seu email!', 'error', 'forgot');
                    return;
                }

                // Valida√ß√£o b√°sica de email
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    this.showMessage('Por favor, informe um email v√°lido!', 'error', 'forgot');
                    return;
                }

                this.setForgotPasswordLoading(true);
                this.showMessage('Os guardas est√£o enviando uma nova palavra secreta...', 'loading', 'forgot');
                
                try {
                    // Importar o supabaseAuth dinamicamente
                    const { supabaseAuth } = await import('./src/core/supabase.js');
                    
                    const result = await supabaseAuth.resetPassword(email);
                    
                    if (result.success) {
                        this.showMessage(`üìß Nova palavra enviada para ${email}!\n\nVerifique sua caixa de entrada e siga as instru√ß√µes dos guardas.`, 'success', 'forgot');
                        
                        // Chamar rea√ß√£o dos guardas ao sucesso
                        if (window.loginGuards) {
                            window.loginGuards.onForgotPasswordSuccess(email);
                        }
                        
                        // Limpar formul√°rio
                        this.forgotEmailInput.value = '';
                        
                        // Ap√≥s 5 segundos, voltar para login
                        setTimeout(() => {
                            this.switchToLogin();
                            this.showMessage('Use o link do email para criar uma nova palavra!', 'success');
                        }, 5000);
                    } else {
                        this.showMessage(result.message || 'Email n√£o encontrado nos pergaminhos do reino!', 'error', 'forgot');
                        
                        // Chamar rea√ß√£o dos guardas ao erro
                        if (window.loginGuards) {
                            window.loginGuards.onForgotPasswordError();
                        }
                    }
                } catch (error) {
                    console.error('Erro no esqueceu senha:', error);
                    this.showMessage('Erro de conex√£o com os guardas. Tente novamente.', 'error', 'forgot');
                } finally {
                    this.setForgotPasswordLoading(false);
                }
            }

            setForgotPasswordLoading(isLoading) {
                this.forgotPasswordButton.disabled = isLoading;
                
                if (isLoading) {
                    this.forgotPasswordButton.innerHTML = `
                        <span class="loading-spinner"></span>
                        Enviando...
                    `;
                } else {
                    this.forgotPasswordButton.innerHTML = `
                        <i class="fas fa-paper-plane"></i>
                        Enviar Nova Palavra
                    `;
                }
            }
        }

        // Inicializar quando DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            new LoginPageAuth();
        });
    </script>

    <!-- Sistema de guardas interativos - Baseado no companion -->
    <script>
        class LoginGuards {
            constructor() {
                this.leftGuard = document.querySelector('.left-guard');
                this.rightGuard = document.querySelector('.right-guard');
                this.leftGuardAvatar = document.getElementById('leftGuardAvatar');
                this.rightGuardAvatar = document.getElementById('rightGuardAvatar');
                this.leftSpeechBubble = this.leftGuard?.querySelector('.guard-speech-bubble');
                this.rightSpeechBubble = this.rightGuard?.querySelector('.guard-speech-bubble');
                this.leftGuardText = document.getElementById('leftGuardText');
                this.rightGuardText = document.getElementById('rightGuardText');
                
                this.leftLastMessage = '';
                this.rightLastMessage = '';
                this.leftHideTimeout = null;
                this.rightHideTimeout = null;
                this.leftAvatarTimeout = null;
                this.rightAvatarTimeout = null;

                // Garantir que os guardas comecem vis√≠veis
                if (this.leftGuard) {
                    this.leftGuard.style.opacity = '1';
                }
                if (this.rightGuard) {
                    this.rightGuard.style.opacity = '1';
                }

                // No mobile, come√ßar com speech bubbles e avatares no estado inicial
                if (window.innerWidth < 1023) {
                    if (this.leftSpeechBubble) {
                        this.leftSpeechBubble.classList.add('hidden');
                    }
                    if (this.rightSpeechBubble) {
                        this.rightSpeechBubble.classList.add('hidden');
                    }
                    // Avatares come√ßam vis√≠veis, mas ser√£o escondidos ap√≥s inatividade
                    if (this.leftGuardAvatar) {
                        this.leftGuardAvatar.classList.add('avatar-show');
                    }
                    if (this.rightGuardAvatar) {
                        this.rightGuardAvatar.classList.add('avatar-show');
                    }
                }
                
                this.leftMessages = [
                    "Alto, viajante! Identifica√ß√£o necess√°ria para prosseguir.",
                    "Estado seu nome e prop√≥sito neste reino!",
                    "Por ordem real, todos devem se identificar.",
                    "Suas credenciais, aventureiro!",
                    "O reino deve conhecer quem cruza nossos port√µes."
                ];
                
                this.rightMessages = [
                    "Os port√µes do Reino aguardam sua passagem autorizada.",
                    "Apresente seus documentos de viagem!",
                    "Nenhum estranho passa sem identifica√ß√£o.",
                    "Prove sua identidade, forasteiro!",
                    "A seguran√ßa do reino √© nossa prioridade."
                ];
                
                this.errorMessages = [
                    "Credenciais inv√°lidas! Tente novamente, impostor!",
                    "Esse n√£o √© um nome reconhecido em nossos pergaminhos!",
                    "Palavra de reconhecimento incorreta, intruso!",
                    "Por Khalmyr! Essas n√£o s√£o as credenciais certas!",
                    "Alto a√≠! Esses dados n√£o conferem com nossos registros!"
                ];
                
                this.successMessages = [
                    "Bem-vindo ao reino, nobre aventureiro!",
                    "Passagem autorizada! Que a fortuna te acompanhe!",
                    "Credenciais aprovadas. Os port√µes se abrem para voc√™!",
                    "Entrada concedida! Que sua jornada seja pr√≥spera!",
                    "Bem-vindo de volta ao Forjador de Lendas!"
                ];
                
                this.registerMessages = [
                    "Interessado em se juntar ao reino? Excelente escolha!",
                    "Novos aventureiros s√£o sempre bem-vindos aqui!",
                    "Vamos registrar suas informa√ß√µes nos pergaminhos oficiais.",
                    "Prepare-se para se tornar um membro oficial do reino!",
                    "O reino sempre precisa de novos her√≥is corajosos!"
                ];

                this.registerSuccessMessages = [
                    "Registro aprovado! Bem-vindo ao reino, aventureiro!",
                    "Pergaminhos assinados! Voc√™ agora √© um de n√≥s!",
                    "Parab√©ns! Seu nome foi inscrito no livro de honra!",
                    "Registro conclu√≠do! Que sua jornada seja lend√°ria!",
                    "Bem-vindo √† nossa irmandade de aventureiros!"
                ];

                this.registerErrorMessages = [
                    "Algo deu errado com o registro. Verifique os dados!",
                    "Este nome j√° consta em nossos pergaminhos!",
                    "Os documentos n√£o foram preenchidos corretamente!",
                    "Registro negado! Verifique as informa√ß√µes fornecidas.",
                    "Erro nos pergaminhos! Tente preencher novamente."
                ];

                this.forgotPasswordMessages = [
                    "Esqueceu sua palavra de reconhecimento? Sem problemas!",
                    "Nossos correios podem enviar uma nova palavra secreta!",
                    "Informe o endere√ßo registrado nos pergaminhos do reino.",
                    "Os guardas da torre de mensagens est√£o prontos para ajudar!",
                    "Uma nova palavra ser√° forjada especialmente para voc√™!"
                ];

                this.forgotPasswordSuccessMessages = [
                    "Pergaminho enviado! Verifique seu correio, aventureiro!",
                    "Nova palavra secreta despachada pelos nossos pombos-correio!",
                    "Mensagem dos guardas enviada! Siga as instru√ß√µes do email.",
                    "Os escribas enviaram sua nova palavra de reconhecimento!",
                    "Correio real despachado! Sua nova chave chegar√° em breve!"
                ];

                this.forgotPasswordErrorMessages = [
                    "Este endere√ßo n√£o consta em nossos pergaminhos!",
                    "Erro no sistema de correios! Tente novamente.",
                    "Email n√£o reconhecido pelos arquivistas do reino!",
                    "Falha na entrega! Verifique o endere√ßo informado.",
                    "Os pombos-correio n√£o encontraram este destino!"
                ];
                
                this.setupEventListeners();
                this.setupMobileEvents();
                this.setupScrollListener();
                this.greet();
            }
            
            setupEventListeners() {
                // Eventos do formul√°rio de login
                const usernameInput = document.getElementById('username');
                const passwordInput = document.getElementById('password');
                
                if (usernameInput) {
                    usernameInput.addEventListener('input', () => this.onUsernameInput());
                }
                
                if (passwordInput) {
                    passwordInput.addEventListener('input', () => this.onPasswordInput());
                }

                // Eventos do formul√°rio de registro
                const regUsernameInput = document.getElementById('regUsername');
                const regEmailInput = document.getElementById('regEmail');
                const regPasswordInput = document.getElementById('regPassword');
                
                if (regUsernameInput) {
                    regUsernameInput.addEventListener('input', () => this.onRegUsernameInput());
                }
                
                if (regEmailInput) {
                    regEmailInput.addEventListener('input', () => this.onRegEmailInput());
                }
                
                if (regPasswordInput) {
                    regPasswordInput.addEventListener('input', () => this.onRegPasswordInput());
                }
            }

            setupMobileEvents() {
                if (this.leftGuardAvatar) {
                    this.leftGuardAvatar.addEventListener('click', () => {
                        if (window.innerWidth < 1023) {
                            if (this.leftSpeechBubble && this.leftSpeechBubble.classList.contains('hidden')) {
                                this.showLastMessage('left');
                            } else {
                                this.hideSpeechBubble('left');
                            }
                        }
                    });
                }
                
                if (this.rightGuardAvatar) {
                    this.rightGuardAvatar.addEventListener('click', () => {
                        if (window.innerWidth < 1023) {
                            if (this.rightSpeechBubble && this.rightSpeechBubble.classList.contains('hidden')) {
                                this.showLastMessage('right');
                            } else {
                                this.hideSpeechBubble('right');
                            }
                        }
                    });
                }
                
                document.addEventListener('click', (e) => {
                    if (window.innerWidth < 1023) {
                        if (!this.leftGuardAvatar?.contains(e.target) &&
                            this.leftSpeechBubble && !this.leftSpeechBubble.contains(e.target) &&
                            !this.leftSpeechBubble.classList.contains('hidden')) {
                            this.hideSpeechBubble('left');
                        }
                        
                        if (!this.rightGuardAvatar?.contains(e.target) &&
                            this.rightSpeechBubble && !this.rightSpeechBubble.contains(e.target) &&
                            !this.rightSpeechBubble.classList.contains('hidden')) {
                            this.hideSpeechBubble('right');
                        }
                    }
                });
            }

            setupScrollListener() {
                let isNearBottom = false;
                const threshold = 150; // Aumentado para dar mais espa√ßo

                const checkFooterPosition = () => {
                    if (window.innerWidth >= 1023) return;

                    const scrollPosition = window.scrollY;
                    const windowHeight = window.innerHeight;
                    const documentHeight = document.documentElement.scrollHeight;
                    const distanceFromBottom = documentHeight - (scrollPosition + windowHeight);

                    // Se o documento √© menor que a viewport, n√£o precisa esconder
                    if (documentHeight <= windowHeight + 50) {
                        if (isNearBottom) {
                            if (this.leftGuard) this.leftGuard.classList.remove('guard-fade-out');
                            if (this.rightGuard) this.rightGuard.classList.remove('guard-fade-out');
                            isNearBottom = false;
                        }
                        return;
                    }

                    if (distanceFromBottom <= threshold) {
                        if (!isNearBottom) {
                            if (this.leftGuard) this.leftGuard.classList.add('guard-fade-out');
                            if (this.rightGuard) this.rightGuard.classList.add('guard-fade-out');
                            isNearBottom = true;
                        }
                    } else {
                        if (isNearBottom) {
                            if (this.leftGuard) this.leftGuard.classList.remove('guard-fade-out');
                            if (this.rightGuard) this.rightGuard.classList.remove('guard-fade-out');
                            isNearBottom = false;
                        }
                    }
                };

                // Verifica no scroll
                window.addEventListener('scroll', checkFooterPosition, { passive: true });

                // Verifica no carregamento
                checkFooterPosition();

                // Verifica tamb√©m no redimensionamento
                window.addEventListener('resize', checkFooterPosition);
            }
            
            speak(guard, text, duration = null) {
                const guardContainer = guard === 'left' ? this.leftGuard : this.rightGuard;
                const speechBubble = guard === 'left' ? this.leftSpeechBubble : this.rightSpeechBubble;
                const textElement = guard === 'left' ? this.leftGuardText : this.rightGuardText;
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                
                if (!speechBubble || !textElement) return;
                
                // Remove fade out
                if (guardContainer) {
                    guardContainer.classList.remove('guard-fade-out');
                }

                // Salva √∫ltima mensagem
                if (guard === 'left') {
                    this.leftLastMessage = text;
                } else {
                    this.rightLastMessage = text;
                }
                
                // Limpa qualquer timeout anterior (speech bubble e avatar)
                if (guard === 'left' && this.leftHideTimeout) {
                    clearTimeout(this.leftHideTimeout);
                    this.leftHideTimeout = null;
                }
                if (guard === 'right' && this.rightHideTimeout) {
                    clearTimeout(this.rightHideTimeout);
                    this.rightHideTimeout = null;
                }

                // No mobile, mostra o avatar quando h√° nova intera√ß√£o
                if (window.innerWidth < 1023) {
                    this.showAvatar(guard);
                }

                // Mostra o speech bubble
                speechBubble.classList.remove('hidden', 'auto-hide');
                speechBubble.classList.add('show', 'fade-in');
                textElement.textContent = text;
                
                if (window.innerWidth <= 768) {
                    // Em mobile, pisca o avatar quando fala
                    if (avatar) {
                    avatar.style.boxShadow = '0 0 15px var(--accent-color)';
                    setTimeout(() => {
                        avatar.style.boxShadow = '';
                    }, 1000);
                    }
                }

                // No mobile, esconde automaticamente ap√≥s um tempo
                if (window.innerWidth < 1023) {
                    const autoHideDuration = duration || 4000; // 4 segundos padr√£o
                    const timeoutId = setTimeout(() => {
                        this.autoHideSpeechBubble(guard);
                    }, autoHideDuration);

                    if (guard === 'left') {
                        this.leftHideTimeout = timeoutId;
                    } else {
                        this.rightHideTimeout = timeoutId;
                    }
                } else if (duration) {
                    setTimeout(() => this.hideSpeechBubble(guard), duration);
                }
            }

            hideSpeechBubble(guard) {
                const speechBubble = guard === 'left' ? this.leftSpeechBubble : this.rightSpeechBubble;
                if (speechBubble) {
                    speechBubble.classList.remove('show', 'fade-in');
                    speechBubble.classList.add('hidden');
                }
            }
            
            autoHideSpeechBubble(guard) {
                const speechBubble = guard === 'left' ? this.leftSpeechBubble : this.rightSpeechBubble;
                if (speechBubble && window.innerWidth < 1023) {
                    speechBubble.classList.remove('show', 'fade-in');
                    speechBubble.classList.add('auto-hide');
                    
                    // Ap√≥s a transi√ß√£o, adiciona hidden
                    setTimeout(() => {
                        if (speechBubble.classList.contains('auto-hide')) {
                            speechBubble.classList.remove('auto-hide');
                            speechBubble.classList.add('hidden');
                        }
                    }, 800); // Tempo da transi√ß√£o + delay

                    // Inicia timeout para esconder avatar ap√≥s mais tempo
                    this.startAvatarHideTimeout(guard);
                }
            }

            showAvatar(guard) {
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                if (avatar && window.innerWidth < 1023) {
                    // Cancela timeout de esconder avatar se existir
                    if (guard === 'left' && this.leftAvatarTimeout) {
                        clearTimeout(this.leftAvatarTimeout);
                        this.leftAvatarTimeout = null;
                    }
                    if (guard === 'right' && this.rightAvatarTimeout) {
                        clearTimeout(this.rightAvatarTimeout);
                        this.rightAvatarTimeout = null;
                    }

                    avatar.classList.remove('avatar-hidden', 'avatar-auto-hide');
                    avatar.classList.add('avatar-show');
                }
            }

            hideAvatar(guard) {
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                if (avatar && window.innerWidth < 1023) {
                    avatar.classList.remove('avatar-show');
                    avatar.classList.add('avatar-hidden');
                }
            }

            autoHideAvatar(guard) {
                const avatar = guard === 'left' ? this.leftGuardAvatar : this.rightGuardAvatar;
                if (avatar && window.innerWidth < 1023) {
                    avatar.classList.remove('avatar-show');
                    avatar.classList.add('avatar-auto-hide');
                    
                    // Ap√≥s a transi√ß√£o, adiciona hidden
                    setTimeout(() => {
                        if (avatar.classList.contains('avatar-auto-hide')) {
                            avatar.classList.remove('avatar-auto-hide');
                            avatar.classList.add('avatar-hidden');
                        }
                    }, 1100); // Tempo da transi√ß√£o + delay
                }
            }

            startAvatarHideTimeout(guard) {
                const inactivityDuration = 8000; // 8 segundos ap√≥s speech bubble desaparecer
                const timeoutId = setTimeout(() => {
                    this.autoHideAvatar(guard);
                }, inactivityDuration);

                if (guard === 'left') {
                    this.leftAvatarTimeout = timeoutId;
                } else {
                    this.rightAvatarTimeout = timeoutId;
                }
            }
            
            greet() {
                // Sauda√ß√£o inicial alternada
                setTimeout(() => {
                    const duration = window.innerWidth < 1023 ? 3000 : null; // 3 segundos no mobile
                    this.speak('left', this.leftMessages[0], duration);
                }, 500);
                
                setTimeout(() => {
                    const duration = window.innerWidth < 1023 ? 3000 : null; // 3 segundos no mobile
                    this.speak('right', this.rightMessages[0], duration);
                }, 2000);

                // No mobile, inicia timeout de inatividade total ap√≥s as sauda√ß√µes
                if (window.innerWidth < 1023) {
                    setTimeout(() => {
                        this.startInitialInactivityTimeout();
                    }, 8000); // 8 segundos ap√≥s as sauda√ß√µes iniciais
                }
            }

            startInitialInactivityTimeout() {
                // Timeout para esconder avatares se n√£o houver intera√ß√£o
                const totalInactivityDuration = 15000; // 15 segundos de inatividade total
                
                this.leftAvatarTimeout = setTimeout(() => {
                    this.autoHideAvatar('left');
                }, totalInactivityDuration);
                
                this.rightAvatarTimeout = setTimeout(() => {
                    this.autoHideAvatar('right');
                }, totalInactivityDuration);
            }
            
            onUsernameInput() {
                const username = document.getElementById('username')?.value.trim();
                if (username && username.length > 2) {
                    const responses = [
                        `${username}? Verificando nos registros...`,
                        `Nome anotado: ${username}. Aguardo a palavra de reconhecimento.`,
                        `${username}... *consulta pergaminho* Prossiga com a identifica√ß√£o.`
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('left', responses[Math.floor(Math.random() * responses.length)], duration);
                }
            }
            
            onPasswordInput() {
                const messages = [
                    "Palavra de reconhecimento em an√°lise...",
                    "Verificando autoriza√ß√£o...",
                    "*Examina cuidadosamente os c√≥digos*"
                ];
                const duration = window.innerWidth < 1023 ? 3500 : null;
                this.speak('right', messages[Math.floor(Math.random() * messages.length)], duration);
            }

            // M√©todos de rea√ß√£o para campos de registro
            onRegUsernameInput() {
                const username = document.getElementById('regUsername')?.value.trim();
                if (username && username.length > 2) {
                    const responses = [
                        `${username}? Um nome digno de um aventureiro!`,
                        `Anotando "${username}" nos pergaminhos...`,
                        `${username}... *escreve cuidadosamente* Nome registrado!`,
                        `Bom nome de aventureiro! Prossiga com o cadastro.`
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('left', responses[Math.floor(Math.random() * responses.length)], duration);
                }
            }

            onRegEmailInput() {
                const email = document.getElementById('regEmail')?.value.trim();
                if (email && email.includes('@')) {
                    const messages = [
                        "Correio do reino anotado nos registros!",
                        "Endere√ßo v√°lido! Prossiga com o cadastro.",
                        "*Anota o endere√ßo no pergaminho oficial*",
                        "Correio registrado para comunica√ß√µes futuras!"
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('right', messages[Math.floor(Math.random() * messages.length)], duration);
                }
            }

            onRegPasswordInput() {
                const password = document.getElementById('regPassword')?.value;
                if (password && password.length >= 4) {
                    const messages = [
                        "Palavra secreta sendo cifrada...",
                        "*Codifica a palavra nos pergaminhos secretos*",
                        "For√ßa da palavra: " + (password.length >= 8 ? "Excelente!" : "Adequada."),
                        "Palavra de reconhecimento em processamento..."
                    ];
                    const duration = window.innerWidth < 1023 ? 3500 : null;
                    this.speak('left', messages[Math.floor(Math.random() * messages.length)], duration);
                }
            }

            // Fun√ß√£o para mostrar √∫ltima mensagem (mobile)
            showLastMessage(guard) {
                const lastMessage = guard === 'left' ? this.leftLastMessage : this.rightLastMessage;
                const guardContainer = guard === 'left' ? this.leftGuard : this.rightGuard;
                
                if (lastMessage) {
                    if (guardContainer) {
                        guardContainer.classList.remove('guard-fade-out');
                    }
                    // Mostra avatar tamb√©m quando clica para ver √∫ltima mensagem
                    if (window.innerWidth < 1023) {
                        this.showAvatar(guard);
                    }
                    this.speak(guard, lastMessage);
                }
            }

            // M√©todo para ser chamado pelo sistema de login
            onLoginSuccess() {
                    const successMessage = this.successMessages[Math.floor(Math.random() * this.successMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', successMessage, duration);
                    
                    setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Port√µes abertos! Bem-vindo ao reino!", duration2);
                    }, 1000);
            }

            onLoginError() {
                const errorMessage = this.errorMessages[Math.floor(Math.random() * this.errorMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', errorMessage, duration);
                
                    setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Tente novamente, mas com as credenciais corretas!", duration2);
                }, 1500);
            }

            // M√©todos para registro
            onSwitchToRegister() {
                const registerMessage = this.registerMessages[Math.floor(Math.random() * this.registerMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', registerMessage, duration);
                    
                    setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Preencha o formul√°rio com suas informa√ß√µes!", duration2);
                }, 1000);
            }

            onSwitchToLogin() {
                const duration = window.innerWidth < 1023 ? 3000 : null;
                this.speak('left', "De volta ao reconhecimento! Informe suas credenciais.", duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 3000 : null;
                    this.speak('right', "Apresente sua identifica√ß√£o para entrar!", duration2);
                }, 1000);
            }

            onRegisterSuccess(username) {
                const successMessage = this.registerSuccessMessages[Math.floor(Math.random() * this.registerSuccessMessages.length)];
                const duration = window.innerWidth < 1023 ? 5000 : null;
                this.speak('left', successMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 5000 : null;
                    this.speak('right', `${username}, agora fa√ßa login para acessar o reino!`, duration2);
                    }, 1500);
                }

            onRegisterError() {
                const errorMessage = this.registerErrorMessages[Math.floor(Math.random() * this.registerErrorMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', errorMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Corrija os dados e tente registrar novamente!", duration2);
                }, 1500);
            }

            // M√©todos para esqueceu senha
            onSwitchToForgotPassword() {
                const forgotMessage = this.forgotPasswordMessages[Math.floor(Math.random() * this.forgotPasswordMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', forgotMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Digite seu email e enviaremos uma nova palavra!", duration2);
                }, 1000);
            }

            onForgotPasswordSuccess(email) {
                const successMessage = this.forgotPasswordSuccessMessages[Math.floor(Math.random() * this.forgotPasswordSuccessMessages.length)];
                const duration = window.innerWidth < 1023 ? 5000 : null;
                this.speak('left', successMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 5000 : null;
                    this.speak('right', `Nova palavra enviada para ${email}! Verifique sua caixa de entrada.`, duration2);
                }, 1500);
            }

            onForgotPasswordError() {
                const errorMessage = this.forgotPasswordErrorMessages[Math.floor(Math.random() * this.forgotPasswordErrorMessages.length)];
                const duration = window.innerWidth < 1023 ? 4000 : null;
                this.speak('left', errorMessage, duration);
                
                setTimeout(() => {
                    const duration2 = window.innerWidth < 1023 ? 4000 : null;
                    this.speak('right', "Verifique o email e tente novamente!", duration2);
                }, 1500);
            }
        }
        
        // Inicializar guardas quando DOM estiver pronto
        document.addEventListener('DOMContentLoaded', () => {
            window.loginGuards = new LoginGuards();
        });
    </script>
</body>
</html> 